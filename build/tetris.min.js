!function e(t,i,n){function r(o,l){if(!i[o]){if(!t[o]){var s="function"==typeof require&&require;if(!l&&s)return s(o,!0);if(a)return a(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var f=i[o]={exports:{}};t[o][0].call(f.exports,function(e){var i=t[o][1][e];return r(i?i:e)},f,f.exports,e,t,i,n)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,i){(function(t){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}var n=e("./TetrisApp"),r=i(n),a=e("./TetrisCanvasRenderer"),o=i(a),l=e("./KeyboardController"),s=i(l);t.TetrisApp=r["default"],t.TetrisCanvasRenderer=o["default"],t.KeyboardController=s["default"],window.onload=function(){var e=new o["default"]("tetris",12,24),t=new s["default"]("tetris"),i=new r["default"](e,t);i.run()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./KeyboardController":3,"./TetrisApp":5,"./TetrisCanvasRenderer":6}],2:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=function(){function e(){n(this,e),this._lastUpdate=0}return r(e,[{key:"onFrame",value:function(e){}},{key:"run",value:function(){var e=this;window.requestAnimationFrame(function(t){e._updateFrame(t)})}},{key:"_updateFrame",value:function(e){var t=this;0!==this._lastUpdate&&this.onFrame((e-this._lastUpdate)/1e3),this._lastUpdate=e,window.requestAnimationFrame(function(e){t._updateFrame(e)})}}]),e}();i["default"]=a},{}],3:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a={ArrowLeft:"MoveLeft",ArrowRight:"MoveRight",ArrowUp:"Rotate",ArrowDown:"IncreaseFallRate",Space:"Drop",KeyZ:"Hold",KeyR:"Reset"},o=function(){function e(t){var i=this;n(this,e),this._element=document.getElementById(t),this._listener=null,window.addEventListener("keydown",function(e){var t=a[e.code];t&&i._listener&&i._listener(t)},!1),window.addEventListener("keyup",function(e){"ArrowDown"===e.code&&i._listener&&i._listener("ResetFallRate")},!1)}return r(e,[{key:"onEvent",value:function(e){this._listener=e}}]),e}();i["default"]=o},{}],4:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t["default"]=e,t}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=e("./Util"),s=r(l),u=e("./Types"),f=n(u),h=[100,300,400,500],c=function(){function e(t,i){a(this,e),this._size={w:t,h:i},this.reset()}return o(e,[{key:"start",value:function(){this._state.playing=!0}},{key:"stop",value:function(){this._state.playing=!1}},{key:"reset",value:function(){this._state={grid:[],falling:this._generateTetromino(),next:this._generateTetromino(),held:null,playing:!0,lines:0,score:0,level:1};for(var e=0;e<this._size.w*this._size.h;e++)this._state.grid.push(0);this._fallMult=1,this._fallDelta=0,this._fallRate=2,this._restrictHold=!1,this._updateCollisionPoint()}},{key:"moveLeft",value:function(){if(this._state.playing!==!1){var e=this._state.falling;e.pos.x>0&&(this._collides(e.type,e.pos.x-1,e.pos.y)||(e.pos.x--,this._updateCollisionPoint()))}}},{key:"moveRight",value:function(){if(this._state.playing!==!1){var e=this._state.falling;e.pos.x+e.type.w<this._size.w&&(this._collides(e.type,e.pos.x+1,e.pos.y)||(e.pos.x++,this._updateCollisionPoint()))}}},{key:"drop",value:function(){if(this._state.playing!==!1){var e=this._state.falling;this._state.score+=(e.collisionPoint-e.pos.y)*this._state.level,e.pos.y=e.collisionPoint,this._handleCollision(),this._fallDelta=0}}},{key:"rotate",value:function(){if(this._state.playing!==!1){for(var e=this._state.falling,t={w:e.type.h,h:e.type.w,color:e.type.color,data:[]},i=0;i<e.type.w;i++)for(var n=e.type.h-1;n>=0;n--){var r=s.getArrayIdx(i,n,e.type.w);t.data.push(e.type.data[r])}var a=e.pos.x+t.w-this._size.w;a>0&&(e.pos.x-=a),this._collides(t,e.pos.x,e.pos.y)||(e.type=t),this._updateCollisionPoint()}}},{key:"hold",value:function(){if(this._state.playing!==!1&&this._restrictHold!==!0){var e=this._state.held,t=this._state.falling;e?this._state.falling=e:(this._state.falling=this._state.next,this._state.next=this._generateTetromino()),t.pos.y=-t.type.h,this._state.held=t,this._restrictHold=!0,this._updateCollisionPoint()}}},{key:"update",value:function(e){this._state.playing!==!1&&(this._fallDelta+=e*this._fallMult*this._fallRate,this._fallDelta>1&&(this._updateFalling(),this._fallDelta%=1))}},{key:"_updateFalling",value:function(){for(var e=this._state.falling,t=Math.floor(this._fallDelta),i=0;i<t;i++){if(this._collides(e.type,e.pos.x,e.pos.y+1))return void this._handleCollision();e.pos.y++}this._fallMult>1&&(this._state.score+=this._state.level),this._updateCollisionPoint()}},{key:"_collides",value:function(e,t,i){if(i+e.h>this._size.h)return!0;for(var n=0;n<e.h;n++){var r=i+n;if(r>=0)for(var a=0;a<e.w;a++){var o=s.getArrayIdx(a,n,e.w),l=e.data[o];if(0!==l){var u=s.getArrayIdx(t+a,r,this._size.w);if(0!==this._state.grid[u])return!0}}}return!1}},{key:"_handleCollision",value:function(){this._bake(this._state.falling),this._state.falling.pos.y>=0?this._removeCompleted():this.stop(),this._state.falling=this._state.next,this._state.next=this._generateTetromino(),this._restrictHold=!1,this._updateCollisionPoint()}},{key:"_updateCollisionPoint",value:function(){for(var e=this._state.falling,t=0;!this._collides(e.type,e.pos.x,e.pos.y+t+1);)t++;e.collisionPoint=e.pos.y+t}},{key:"_removeCompleted",value:function(){for(var e=0,t=this._size.h-1;t>0;t--){for(var i=!0,n=0;n<this._size.w;n++){var r=s.getArrayIdx(n,t,this._size.w);if(0===this._state.grid[r]){i=!1;break}}i&&(this._shiftRows(t),e++,t++)}e>0&&(this._state.lines+=e,this._state.level=Math.floor(this._state.lines/10)+1,this._state.score+=h[e-1]*this._state.level,this._fallRate=this._state.level,this._updateCollisionPoint())}},{key:"_shiftRows",value:function(e){for(var t=this._state.grid,i=e;i>1;i--)for(var n=0;n<this._size.w;n++){var r=s.getArrayIdx(n,i,this._size.w);t[r]=t[r-this._size.w]}for(var a=0;a<this._size.w;a++)t[a]=0}},{key:"_bake",value:function(e){for(var t=0;t<e.type.h;t++)for(var i=0;i<e.type.w;++i){var n=e.type.data[t*e.type.w+i];if(0!==n){var r=s.getArrayIdx(e.pos.x+i,e.pos.y+t,this._size.w);this._state.grid[r]=e.type.color}}}},{key:"_generateTetromino",value:function(){var e=Math.floor(Math.random()*(f["default"].length-1e-5)),t=f["default"][e];return{type:s.deepClone(t),pos:{x:Math.floor(this._size.w/2),y:-t.h},collisionPoint:0}}},{key:"state",get:function(){return this._state}},{key:"fallRateMultiplier",get:function(){return this._fallMult},set:function(e){this._fallMult=e}}]),e}();i["default"]=c},{"./Types":7,"./Util":8}],5:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(i,"__esModule",{value:!0});var l=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=e("./FrameUpdater"),u=n(s),f=e("./Tetris"),h=n(f),c=function(e){function t(e,i){r(this,t);var n=a(this,Object.getPrototypeOf(t).call(this));return n._renderer=e,n._controller=i,n._game=new h["default"](e.gridSize.w,e.gridSize.h),i.onEvent(function(e){switch(e){case"MoveLeft":n._game.moveLeft();break;case"MoveRight":n._game.moveRight();break;case"Rotate":n._game.rotate();break;case"IncreaseFallRate":n._game.fallRateMultiplier=6;break;case"ResetFallRate":n._game.fallRateMultiplier=1;break;case"Drop":n._game.drop();break;case"Hold":n._game.hold();break;case"Reset":n._game.reset()}}),n}return o(t,e),l(t,[{key:"onFrame",value:function(e){this._game.update(e),this._renderer.render(this._game.state,e)}}]),t}(u["default"]);i["default"]=c},{"./FrameUpdater":2,"./Tetris":4}],6:[function(e,t,i){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t["default"]=e,t}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=e("./Util"),l=n(o),s=1,u={x:s,y:s},f=function(){function e(t,i,n){r(this,e),this._canvas=document.getElementById(t),this._context=this._canvas.getContext("2d"),this._gridSize={w:i,h:n},this._gridLength=i*n,this._blockSize=16,this._finishIdx=-1,this._canvas.width=i*this._blockSize+300,this._canvas.height=n*this._blockSize+2*s}return a(e,[{key:"render",value:function(e,t){var i=this._canvas,n=this._context,r=this._gridSize;n.fillStyle="black",n.fillRect(0,0,i.width,i.height),n.strokeStyle="gray",n.beginPath(),n.rect(0,0,this._gridSize.w*this._blockSize+2*s,this._gridSize.h*this._blockSize+2*s),n.stroke();var a=this._gridSize.w*this._blockSize+40;n.fillStyle="white",n.font="14px 'Press Start 2P'";var o=30;n.fillText("Next:",a,o);var f={x:a,y:o+30};this._drawTetromino(e.next.type,{x:0,y:0},e.next.type.color,f),n.fillStyle="white",n.fillText("Held:",a+125,o);var h={x:a+125,y:o+30};e.held&&this._drawTetromino(e.held.type,{x:0,y:0},e.held.type.color,h),n.fillStyle="white",o=150,n.fillText("Lines: "+e.lines,a,o),n.fillText("Score: "+e.score,a,o+20),n.fillText("Level: "+e.level,a,o+40),e.playing?this._finishIdx=this._gridLength:this._finishIdx>=0&&(this._finishIdx-=8);for(var c=0;c<r.h;c++)for(var _=0;_<r.w;++_){var d=l.getArrayIdx(_,c,r.w),p=e.grid[d];0!==p&&(e.playing||this._finishIdx>d?this._drawBlock(_,c,p,u):this._drawBlock(_,c,"gray",u))}if(e.playing){var y={x:e.falling.pos.x,y:e.falling.collisionPoint};this._drawTetromino(e.falling.type,y,"rgb(60, 60, 60)",u),this._drawTetromino(e.falling.type,e.falling.pos,e.falling.type.color,u)}}},{key:"_drawTetromino",value:function(e,t,i,n){for(var r=0;r<e.h;r++)if(t.y+r>=0)for(var a=0;a<e.w;a++){var o=l.getArrayIdx(a,r,e.w);0!==e.data[o]&&this._drawBlock(t.x+a,t.y+r,i,n)}}},{key:"_drawBlock",value:function(e,t,i,n){var r=this._context,a=this._blockSize;r.fillStyle=i,r.strokeStyle="black",r.lineWidth=1,r.beginPath(),r.rect(e*a+n.x,t*a+n.y,a,a),r.fill(),r.stroke()}},{key:"gridSize",get:function(){return this._gridSize}}]),e}();i["default"]=f},{"./Util":8}],7:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=[{w:2,h:2,color:"yellow",data:[1,1,1,1]},{w:3,h:2,color:"green",data:[0,1,0,1,1,1]},{w:3,h:2,color:"red",data:[1,1,0,0,1,1]},{w:3,h:2,color:"blue",data:[0,1,1,1,1,0]},{w:2,h:3,color:"purple",data:[1,1,1,0,1,0]},{w:2,h:3,color:"orange",data:[1,1,0,1,0,1]},{w:1,h:4,color:"#ff00bf",data:[1,1,1,1]}];i["default"]=n},{}],8:[function(e,t,i){"use strict";function n(e,t,i){return t*i+e}function r(e){return JSON.parse(JSON.stringify(e))}Object.defineProperty(i,"__esModule",{value:!0}),i.getArrayIdx=n,i.deepClone=r},{}]},{},[1]);